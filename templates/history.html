{% extends "layout.html" %}

{% block title %}
    History
{% endblock %}

{% block main %}
    <table class="table table-striped table-hover">
        <thead class="">
            <tr>
                <th class="text-start">Breathwork</th>
                <th class="text-end">Duration</th>
                <th class="text-start">Notes</th>
                <th class="text-start">Date</th>
                <th>Delete</th>
            </tr>
        </thead>
        <tbody>
            {% for breathwork_log in breathwork_logs %}
                <tr id="row-{{ breathwork_log.id }}">
                    <td class="text-start">{{ breathwork_log['name'] }}</td>
                    <td class="text-end">
                        {{ breathwork_log['minutes']}}m
                        {{ breathwork_log['seconds']}}s
                    </td>
                    <td class="text-start">{{ breathwork_log['notes'] }}</td>
                    <td class="text-start utc_log_date" data-date="{{ breathwork_log.log_date }}">{{ breathwork_log['log_date'] }}</td>
                    <td>
                        <button data-id="{{ breathwork_log.id }}" class="btn btn-sm btn-danger delete-btn">Delete</button>
                    </td>
                </tr>
            {% endfor %}
        </tbody>
    </table>
    <script>
        // change the UTC time (default in DB) to the user's local timezone dynamically by browser using JS
        document.addEventListener("DOMContentLoaded", function() {
            document.querySelectorAll(".utc_log_date").forEach(function(element) {
                const utc = element.dataset.date + " UTC";
            // create a date object from utc string, to be displayed as the user's local timezone
                const localDate = new Date(utc);
            // JS asks for user's timezone and converts that UTC timestamp into a human-readable string a
                element.textContent = localDate.toLocaleString([], {
                    year: 'numeric',
                    month: 'short',
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                });
            });
        });

        document.querySelectorAll(".delete-btn").forEach(function(deleteBtn) {
        // I used AJAX so that the deleted breathwork be removed from the table without the need to reload the page
            deleteBtn.addEventListener("click", async function(event) {
                if (!confirm("Are you sure you want to delete this record!")) {
                    event.preventDefault();
                    return;
                }
            // request to delete the row from DB
                let logId = this.dataset.id;
                let response = await fetch(`/delete-log/${logId}`, {
                    method: "DELETE"
                });
                if (response.ok) {
                // now remove that row from DOM
                    document.getElementById(`row-${logId}`).remove();
                } else {
                    alert("Failed to delete the log.")
                }
            });
        });
    </script>
{% endblock %}
